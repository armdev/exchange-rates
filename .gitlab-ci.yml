image: maven:3.3.9-jdk-8

stages:
  - build
  - deploy
  - dockerize
  - deliver

services:
  - docker:dind  
  
cache:
  key: ${CI_BUILD_NAME}
  paths:
   - rates-backend/
   - rates-web/

build:
  image: maven:3.3.9-jdk-8
  stage: build 
  script:    
    - "mvn clean package -B -Dmaven.test.skip=false"
    - "ls -al"  
  artifacts:
        paths:
        - "rates-backend/target/rates-backend-1.0-SNAPSHOT.jar"      
  allow_failure: false


deploy:
  stage: deploy
  script: "echo deploy started"
  only:
    - master
 
dockerize:
  when : manual
  only:
    - master    
    - /^release-.$/
  variables:
    TOKEN: "simpletokeneyJhbGciOiJS"
    OBJECT_CODE: "rates"
    IMG_NAME: "awl-cool-rates"
    TAG: "latest"
    GIT_REPO_URL: "git@gitlab.rates.git"
    DOCKERFILE_DIR: "server"
    BRANCH: "develop"
  stage: dockerize
  script:
    - POM_VERSION=$(mvn -q -Dexec.executable="echo" -Dexec.args='${project.version}' --non-recursive exec:exec)
    
deliver:
  stage: deliver
  script: "echo deploy started"
  only:
    - master
     